---
title: "Online Harvest Survey Annual Summary Report"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    toc: true
    number_sections: true
params:
  inpath:
    value: x
  year:
    value: x
---

```{r, libs, message = FALSE, warning = FALSE, echo = FALSE}

library(tidyverse)
library(MetBrewer)
library(DT)

# Input path
inpath <- params$inpath

# Read data 
invisible(read_dhs(inpath, year = as.character(params$year)))

# Add seaducks to the season metadata
all_seasons <- paste0("all_seasons_", as.character(params$year))
invisible(assign(all_seasons, add_seaducks(get(all_seasons)), envir = .GlobalEnv))

# Write tibble names to list for function compatibility
tibblelist <-
  vector("list", 3) %>% 
  set_names(
    all_seasons,
    paste0("daily_records_", as.character(params$year)),
    paste0("season_totals_", as.character(params$year)))
```

## Introduction

This is the `r params$year` season report for Harvest Survey online data.

## Check for missing data

For the season data, what species are missing per state?

```{r, nodata2, message = FALSE, warning = FALSE, echo = F}
datatable(
  nodata(
    data = get(names(tibblelist[3])), 
    ref_data = get(names(tibblelist[1])), 
    species = "all"), 
  options = list(pageLength = 5))
```

For the daily data, what species are missing per state?

```{r, nodata4, message = FALSE, warning = FALSE, echo = F}
datatable(
  nodata(
    data = get(names(tibblelist[2])), 
    ref_data = get(names(tibblelist[1])), 
    species = "all"), 
  options = list(pageLength = 5))
```


## Finalized records

### Season 

How many records were finalized in the season data? (Records must also have answered "yes" to has hunted.)

#### Total

```{r, submitted1, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo = F}
knitr::kable(
  submitted(get(names(tibblelist[3]))) %>% 
    rename(`Has submitted?` = has_submitted) %>% 
    mutate(prop = round(n/sum(n), 2)))
```

#### By state

```{r, submitted2, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo = F}

submitted(get(names(tibblelist[3])), type = "state", output = "plot") +
  scale_fill_manual(values = met.brewer("Hokusai3", 2)) + 
  theme(legend.position = "bottom")
```

### Daily

How many records were finalized in the daily data? (Records must also have answered "yes" to has hunted.)

#### Total

```{r, submitted4, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo = F}
knitr::kable(
  submitted(get(names(tibblelist[2]))) %>% 
    rename(`Has submitted?` = has_submitted) %>% 
    mutate(prop = round(n/sum(n), 2)))
```

#### By state

```{r, submitted5, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo = F}

submitted(get(names(tibblelist[2])), type = "state", output = "plot") +
  scale_fill_manual(values = met.brewer("Hokusai3", 2)) + 
  theme(legend.position = "bottom")
```


## Has hunted?

### Season

How many hunters hunted in the season data?

#### Total

```{r, hunted1, message = FALSE, warning = FALSE, echo = FALSE}

knitr::kable(
  hunted(get(names(tibblelist[3]))) %>% 
    rename(`Has hunted?` = has_hunted) %>% 
    mutate(prop = round(n/sum(n), 2)))
```

#### By state

```{r, hunted2, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo  = F}

hunted(get(names(tibblelist[3])), type = "state", output = "plot") +
  scale_fill_manual(values = met.brewer("Hokusai3", 2)) + 
  theme(legend.position = "bottom")
```

### Daily

How many hunters hunted in the daily data?

#### By state

```{r, hunted5, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo  = F}

hunted(get(names(tibblelist[2])), type = "state", output = "plot") +
  scale_fill_manual(values = met.brewer("Hokusai3", 2)) + 
  theme(legend.position = "bottom")
```

#### By species

```{r, hunted6, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo  = F}

hunted(get(names(tibblelist[2])), type = "species", output = "plot") +
  scale_fill_manual(values = met.brewer("Hokusai3", 2)) + 
  theme(legend.position = "bottom")
```


## Identify party hunts

Are there any group hunts in the daily data that we can identify via comments?

```{r, party, message = FALSE, warning = FALSE, echo = F}
datatable(
  partyhunt(get(names(tibblelist[2]))) %>% 
    select(-unretrieved), 
  options = list(pageLength = 3))
```


## Check for overdays

Are there any hunts submitted with an impossible number of days hunted?

### Season

```{r, overdays1, message = FALSE, warning = FALSE, echo = F}
datatable(
  overdays(get(names(tibblelist[3])), get(names(tibblelist[1])))
)
```

### Daily 

```{r, overdays2, message = FALSE, warning = FALSE, echo = F}
datatable(
  overdays(get(names(tibblelist[2])), get(names(tibblelist[1]))) 
)
```

## Check for overbags

### Season

What values are over the limit per species and state in the season totals data? Total retrieved values are divided by number of days hunted. Values over the daily limit per state and species are shown below.

```{r, overbags1, message = FALSE, warning = FALSE, echo = F}
datatable(
  overbags(get(names(tibblelist[3])), get(names(tibblelist[1]))) 
)
```


### Daily

What values in the retrieved field of daily data were over the limit per species and state?

```{r, overbags2, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo  = F}
overbags(get(names(tibblelist[2])), get(names(tibblelist[1]))) %>% 
  rename(
    state = sampled_state,
    sp = sp_group_estimated) %>% 
  mutate(
    sp = ifelse(str_detect(sp, "Sea"), "Sea Ducks", sp)) %>% 
  left_join(
    tibble(
      state = state.name,
      state_abbr = state.abb),
    by = "state") %>% 
  mutate(bag_lim_label = "Bag limit") %>% 
  ggplot() + 
  geom_point(aes(x = state_abbr, y = bag_limit, shape = bag_lim_label), 
             color = "red", size = 6) + 
  geom_boxplot(aes(x = state_abbr, y = retrieved), show.legend = F) +
  theme_classic() + 
  labs(y = "Number of birds retrieved", x = "State", shape = "") +
  scale_shape_manual(values = "-", labels = "Bag limit") +
  theme(legend.position = "bottom") +
  facet_grid(
    ~sp, 
    scales = "free", 
    space = "free", 
    labeller = label_wrap_gen(width = 5))
```

```{r, overbags3, message = FALSE, warning = FALSE, echo = F}
datatable(
  overbags(get(names(tibblelist[2])), get(names(tibblelist[1])), summary = T) %>% 
    rename(
      state = sampled_state,
      sp = sp_group_estimated) %>% 
    mutate(
      sp = ifelse(str_detect(sp, "Sea"), "Sea Ducks", sp))
)
```

## Overbags lookup table

```{r, overbags4, message = FALSE, warning = FALSE, echo = F}

datatable(
  overbags(get(names(tibblelist[2])), get(names(tibblelist[1])), summary = F) %>% 
    rename(
      state = sampled_state,
      sp = sp_group_estimated) %>% 
    mutate(
      sp = 
        case_when(
          str_detect(sp, "Sea") ~ "SeaDucks", 
          str_detect(sp, "Mourning") ~ "MODO",
          str_detect(sp, "White") ~ "WWDO",
          str_detect(sp, "Crane") ~ "Cranes",
          TRUE ~ sp) %>% 
        str_remove_all(., " ")) %>% 
    pivot_wider(
      id_cols = 
        c("selected_hunterID", "state", "county", "harvested_date"),
      values_from = retrieved,
      names_from = sp) %>% 
    mutate(over = "Y") %>% 
    bind_rows(
      overbags(get(names(tibblelist[2])), get(names(tibblelist[1])), over = F) %>% 
        rename(
          sp = sp_group_estimated,
          state = sampled_state) %>% 
        mutate(
          sp = 
            case_when(
              str_detect(sp, "Sea") ~ "SeaDucks", 
              str_detect(sp, "Mourning") ~ "MODO",
              str_detect(sp, "White") ~ "WWDO",
              str_detect(sp, "Crane") ~ "Cranes",
              TRUE ~ sp) %>% 
            str_remove_all(., " ")) %>% 
        pivot_wider(
          id_cols = 
            c("selected_hunterID", "state", "county", "harvested_date"),
          values_from = retrieved,
          names_from = sp) %>% 
        mutate(over = "N")) %>% 
    relocate(over, .after = "harvested_date") %>% 
    group_by(selected_hunterID) %>% 
    mutate(n = n()) %>% 
    ungroup() %>% 
    filter(n >= 2) %>% 
    group_by(selected_hunterID) %>% 
    filter("Y" %in% over) %>% 
    ungroup() %>% 
    arrange(selected_hunterID) %>% 
    rename(
      hunterID = selected_hunterID,
      harvest_date = harvested_date) %>% 
    left_join(
      tibble(
        st = state.abb,
        state = state.name),
      by = "state") %>% 
    relocate(st, .before = "county") %>% 
    select(-c("state", "n")) %>% 
    arrange(hunterID, harvest_date) %>% 
    group_by(hunterID) %>% 
    mutate(
      color = 
        ifelse(
          cur_group_id() %% 2 == 0,
          "odd",
          "even"),
      ID = 
        row_number()) %>% 
    ungroup() %>% 
    relocate(ID, .before = "hunterID"), 
  extensions = "Buttons",
  options = 
    list(
      dom = "Bfrti",
      buttons = c("csv", "excel", "pdf"),
      ordering = F, 
      pageLength = -1,
      columnDefs = list(list(visible = F, targets = c(13))),
      scrollX = "1100px",
      scrollY = "500px"),
  width = "1100px",
  height = "500px") %>% 
  formatStyle(
    "color",
    target = "row",
    backgroundColor = styleEqual(c("odd", "even"), c("white", "lightgray"))) %>% 
  formatStyle(
    "over",
    backgroundColor = styleEqual("Y", "pink")) 

```

\  
\  
\  
\  
\  
\  
\  
\  
\  
\  
\  
\  
\  
\  

## Identify out-of-season take

What harvest dates in the daily data fell outside of the legal hunting season per species and state?

```{r, openclose2, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo  = F}

openclose(get(names(tibblelist[2])), get(names(tibblelist[1])), summary = T) %>% 
  rename(
    sp = sp_group_estimated,
    state = sampled_state) %>% 
  left_join(
    tibble(
      state = state.name,
      state_abbr = state.abb),
    by = "state") %>% 
  mutate(prop = n/sum(n)) %>% 
  group_by(state) %>% 
  mutate(
    sum_n = sum(n),
    sum_prop = sum(prop)) %>% 
  ungroup() %>% 
  ggplot() + 
  geom_bar(
    aes(x = reorder(state_abbr, -sum_prop), y = prop, fill = error), 
    stat = "identity") + 
  geom_text(
    aes(x = reorder(state_abbr, -sum_prop), 
        y = sum_prop, 
        label = sum_n, 
        angle = 90),
    vjust = 0.2, hjust = -0.2) +
  scale_y_continuous(expand = expansion(mult = c(-0, 0.4))) +
  theme_classic() + 
  labs(
    y = "Proportion", 
    x = "State", 
    fill = "Error type") +
  theme(legend.position = "bottom") +
  scale_fill_manual(values = met.brewer("Hokusai3", 3))

```

```{r, openclose1, message = FALSE, warning = FALSE, echo = F}
datatable(openclose(get(names(tibblelist[2])), get(names(tibblelist[1])), summary = T))
```

## Retrieved map

```{r, retrievedmap, message = FALSE, warning = FALSE, echo = FALSE, dpi = 300, out.width = 700, fig.align = "center", echo  = F}

retrievedmap(get(names(tibblelist[2])))

```

## Birds retrieved

For the daily data, how many birds were retrieved on average per hunter?

```{r, retrieved2, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo  = F}

retrieved(get(names(tibblelist[2])), output = "plot", average = T) +
  theme(legend.position = "bottom") +
  scale_fill_manual(
    values = 
      met.brewer("Hokusai3", 
                 length(unique(get(names(tibblelist[2]))$sp_group_estimated))))

datatable(retrieved(get(names(tibblelist[2])), average = T))
```


## Popular species

What is the proportion of birds that were successfully hunted? Each hunter's pursued species were grouped for this visualization.

```{r, bagspp1, message = FALSE, warning = FALSE, fig.width = 7, fig.height = 5, dpi = 300, out.width = 500, fig.align = "center", echo = F}

bagspp(get(names(tibblelist[2])), output = "popular")
```


## Days hunted

In the daily data, how many days were spent hunting per species on average for each hunter?

```{r, huntdays3, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo = F}

huntdays(get(names(tibblelist[2])), type = "species", output = "plot", average = T)
```

How about by state?

```{r, huntdays2, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo = F}

huntdays(get(names(tibblelist[2])), output = "plot", average = T) +
  theme(legend.position = "bottom") + 
  scale_fill_manual(
    values = met.brewer("Hokusai3",
                        length(unique(get(names(tibblelist[2]))$sp_group_estimated))))
```

```{r, huntdays1, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo = F}

datatable(huntdays(get(names(tibblelist[2])), average = T))
```

## Comparing submitted vs. non-submit

What is the relationship between number of birds retrieved and number of days spent hunting when data are divided into 4 submission groups?

```{r, compare1, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo = F}
compare(get(names(tibblelist[2])), get(names(tibblelist[3])), type = "line")
```

What is the distribution of number of days hunted per submission group? Bubbles represent number of birds retrieved and red lines indicate mean values. 

```{r, compare2, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo = F}
compare(get(names(tibblelist[2])), get(names(tibblelist[3])), type = "days")
```

What is the distribution of number of birds retrieved per submission group? Bubbles represent number of birds retrieved and red lines indicate mean values.

```{r, compare3, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4, dpi = 300, out.width = 500, fig.align = "center", echo = F}
compare(get(names(tibblelist[2])), get(names(tibblelist[3])), type = "retrieved")
```
